{% extends 'index.html' %}
{% block title %}Book Appointment - MediCare Professional Healthcare{% endblock %}

{% block content %}
<!-- Full-Screen Container Without Gradient Rectangle -->
<div class="min-h-screen flex items-center justify-center px-4 py-12">
    <div class="max-w-3xl w-full">

        <!-- Header -->
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-primary-500 to-primary-600 rounded-full shadow-lg mb-6">
                <i class="fas fa-calendar-plus text-white text-3xl"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight mb-3">
                Book Your Appointment
            </h1>
            <p class="text-gray-600 text-lg">
                Choose your doctor, date, and time slot with ease
            </p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-3 mb-8">
                    {% for category, message in messages %}
                        <div class="p-4 rounded-xl border-l-4 flex items-center gap-3
                            {% if category == 'success' %}
                                bg-green-100 border-green-500 text-green-800
                            {% elif category == 'error' %}
                                bg-red-100 border-red-500 text-red-800
                            {% else %}
                                bg-blue-100 border-blue-500 text-blue-800
                            {% endif %}">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            <span class="font-medium">{{ message }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Appointment Form -->
        <form method="post" id="appointmentForm" class="space-y-7">

            <!-- Doctor Select -->
            <div>
                <label for="doctorSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user-md mr-2 text-primary-500"></i>
                    Select Doctor
                </label>
                <select name="doctor_id" 
                        id="doctorSelect" 
                        required 
                        class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-900 
                               focus:ring-2 focus:ring-primary-400 focus:border-transparent transition">
                    <option value="">Choose a doctor</option>
                    {% for doctor in doctors %}
                        <option value="{{ doctor.id }}">Dr. {{ doctor.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Date Input -->
            <div>
                <label for="dateInput" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar mr-2 text-primary-500"></i>
                    Appointment Date
                </label>
                <input type="date" 
                       name="date" 
                       id="dateInput" 
                       required 
                       class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-900 
                              focus:ring-2 focus:ring-primary-400 focus:border-transparent transition">
            </div>

            <!-- Time Slot -->
            <div>
                <label for="timeSlotSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-clock mr-2 text-primary-500"></i>
                    Time Slot
                </label>
                <select
                    name="time_slot"
                    id="timeSlotSelect"
                    required
                    disabled
                    class="w-full px-4 py-3 rounded-xl bg-white text-gray-900 border border-gray-300
                        focus:ring-2 focus:ring-primary-400 focus:border-transparent transition 
                        disabled:opacity-50 disabled:cursor-not-allowed appearance-none"
                >
                    <option value="" disabled selected>
                        Select date and doctor first
                    </option>
                </select>
            </div>

            <!-- Reason -->
            <div>
                <label for="reasonInput" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-sticky-note mr-2 text-primary-500"></i>
                    Reason for Visit
                </label>
                <input type="text" 
                       name="reason" 
                       id="reasonInput" 
                       required 
                       placeholder="Briefly describe your symptoms"
                       class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-900 placeholder-gray-400 
                              focus:ring-2 focus:ring-primary-400 focus:border-transparent transition">
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                    id="bookButton" 
                    disabled
                    class="w-full flex items-center justify-center px-6 py-4 rounded-xl font-semibold text-lg 
                           bg-gradient-to-r from-primary-500 to-primary-600 text-white shadow-lg hover:scale-105 
                           hover:from-primary-600 hover:to-primary-700 focus:ring-2 focus:ring-primary-400 
                           transition disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                <i class="fas fa-calendar-check mr-3"></i>
                <span id="buttonText">Book Appointment</span>
            </button>
        </form>

        <!-- Back Button -->
        <div class="text-center mt-10">
            <a href="{{ url_for('patient_dashboard') }}" 
               class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-gray-700 
                      bg-gray-100 border border-gray-300 hover:bg-gray-200 hover:scale-105 transition">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const doctorSelect = document.getElementById('doctorSelect');
    const dateInput = document.getElementById('dateInput');
    const timeSlotSelect = document.getElementById('timeSlotSelect');
    const bookButton = document.getElementById('bookButton');
    const buttonText = document.getElementById('buttonText');

    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    function checkAvailability() {
        const doctorId = doctorSelect.value;
        const date = dateInput.value;

        if (!doctorId || !date) {
            timeSlotSelect.innerHTML = '<option value="">Select date and doctor first</option>';
            timeSlotSelect.disabled = true;
            bookButton.disabled = true;
            return;
        }

        timeSlotSelect.innerHTML = '<option>Loading available slots...</option>';
        timeSlotSelect.disabled = true;
        bookButton.disabled = true;
        buttonText.textContent = 'Loading...';

        fetch(`/check_availability?doctor_id=${doctorId}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                timeSlotSelect.innerHTML = '';
                if (data.available_slots.length === 0) {
                    timeSlotSelect.innerHTML = '<option>No slots available</option>';
                    timeSlotSelect.disabled = true;
                    bookButton.disabled = true;
                    buttonText.textContent = 'No Slots Available';
                } else {
                    timeSlotSelect.innerHTML = '<option value="">Select a time slot</option>';
                    data.available_slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        option.textContent = slot;
                        timeSlotSelect.appendChild(option);
                    });
                    timeSlotSelect.disabled = false;
                    buttonText.textContent = 'Book Appointment';
                }
            })
            .catch(error => {
                console.error('Error fetching availability:', error);
                timeSlotSelect.innerHTML = '<option>Error loading slots</option>';
                timeSlotSelect.disabled = true;
                bookButton.disabled = true;
                buttonText.textContent = 'Error Loading Slots';
            });
    }

    function validateForm() {
        const doctorId = doctorSelect.value;
        const date = dateInput.value;
        const timeSlot = timeSlotSelect.value;
        const reason = document.getElementById('reasonInput').value.trim();

        const isValid = doctorId && date && timeSlot && reason;
        bookButton.disabled = !isValid;

        if (isValid) {
            buttonText.textContent = 'Book Appointment';
        }
    }

    doctorSelect.addEventListener('change', checkAvailability);
    dateInput.addEventListener('change', checkAvailability);
    timeSlotSelect.addEventListener('change', validateForm);
    document.getElementById('reasonInput').addEventListener('input', validateForm);

    document.getElementById('appointmentForm').addEventListener('submit', function(e) {
        const doctorId = doctorSelect.value;
        const date = dateInput.value;
        const timeSlot = timeSlotSelect.value;
        const reason = document.getElementById('reasonInput').value.trim();

        if (!doctorId || !date || !timeSlot || !reason) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return;
        }

        buttonText.textContent = 'Booking...';
        bookButton.disabled = true;
    });
});
</script>
{% endblock %}
